#!/usr/bin/env node
const gitUtil = require('../src/util/git-util');
const fileUtil = require('../src/util/file-util');
const inquirerUtil = require('../src/util/inquirer-util');
const settingUtil = require('../src/util/setting-util');
const path = require('path');
const ora = require('ora');

(async () => {
  const { token } = await gitUtil.getAccessToken();
  const { url, save } = await inquirerUtil.chooseRepository();
  const { username, repository } = gitUtil.parseUrl(url);
  const branches = await gitUtil.getBranches(repository, username, token);
  const { branch } = await inquirerUtil.chooseBranch(branches);

  if (save) settingUtil.saveCustomRepository(url);

  const spinner = ora('Downloading branch...').start();
  await gitUtil.downloadRepository(username, repository, branch);
  spinner.text = 'Extracting data...';
  await fileUtil.extractBranchZip(repository, branch);
  spinner.text = 'Moving data...';
  await fileUtil.moveFiles(`${path.resolve()}/${repository}`, path.resolve());
  spinner.text = 'Deleting temp data...';
  await fileUtil.deleteFile(gitUtil.branchToZipName(branch));
  spinner.stop();
  console.log('Done.');
})();
